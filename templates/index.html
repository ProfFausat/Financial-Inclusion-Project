<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Inclusion - AI Targeting</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="overlay"></div>

    <header>
        <div class="logo">Created by Fausat Ibrahim | Independent Data Scientist</div>
        <div class="branding"></div>
    </header>

    <main>
        <div class="container">
            <div class="glass-card main-form">
                <h1>Financial Inclusion Predictor</h1>
                <p>Identify unbanked individuals likely to open an account using advanced SVM targeting.</p>

                <!-- Model Insights Panel -->
                <div class="insights-toggle">
                    <button id="toggleInsights" class="insights-btn">ðŸ“Š View Model Insights</button>
                </div>

                <div id="modelInsights" class="model-insights hidden">
                    <h3>Model Performance</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <span class="metric-label">ROC-AUC</span>
                            <span class="metric-value" id="aucMetric">Loading...</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">Recall (Unbanked)</span>
                            <span class="metric-value" id="recallMetric">Loading...</span>
                        </div>
                        <div class="metric-card">
                            <span class="metric-label">Precision (Unbanked)</span>
                            <span class="metric-value" id="precisionMetric">Loading...</span>
                        </div>
                    </div>

                    <h3>Top 5 Important Features</h3>
                    <div class="feature-importance" style="height: 400px; position: relative; margin-bottom: 2rem;">
                        <canvas id="featureChart"></canvas>
                    </div>

                    <h3>Project Details</h3>
                    <div class="explanation">
                        <ul>
                            <li style="margin-bottom:12px;">
                                This application uses a calibrated Linear Support Vector Machine (SVM) to support
                                precision targeting for financial inclusion outreach.
                            </li>
                            <li style="margin-bottom:12px;">
                                The model was trained on Global Findex 2025 microdata and learns from 17 leakage-safe
                                socioeconomic indicators, transformed into 22 features through encoding and explicit
                                missing-data signals.
                            </li>
                            <li style="margin-bottom:12px;">
                                It outputs a probability-based risk score that predicts individualsâ€™ likelihood of being
                                banked or unbanked.
                            </li>
                            <li style="margin-bottom:12px;">
                                Model behavior is validated using permutation importance and partial dependence
                                analysis, ensuring predictions are driven by meaningful socioeconomic signals rather
                                than circular or outcome-adjacent features. The top 5 features are displayed above.
                            </li>
                            <li style="margin-bottom:12px;">
                                The system is deployed as a production-ready Flask API, enabling real-time scoring
                                of new data for efficient, ROI-aware financial inclusion programs.
                            </li>
                        </ul>
                    </div>

                </div>

                <form id="predictionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="world_bank_region">Region</label>
                            <select name="world_bank_region" id="world_bank_region" required>
                                <option value="Sub-Saharan Africa">Sub-Saharan Africa</option>
                                <option value="South Asia">South Asia</option>
                                <option value="East Asia & Pacific">East Asia & Pacific</option>
                                <option value="Latin America & Caribbean">Latin America & Caribbean</option>
                                <option value="Middle East & North Africa">Middle East & North Africa</option>
                                <option value="Europe & Central Asia">Europe & Central Asia</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="age_years">Age</label>
                            <input type="number" name="age_years" id="age_years" placeholder="25" required>
                        </div>
                        <div class="form-group">
                            <label for="income_quintile">Income Quintile (1-5)</label>
                            <input type="number" name="income_quintile" id="income_quintile" min="1" max="5" value="3"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="education_level">Education Level (1-3)</label>
                            <select name="education_level" id="education_level" required>
                                <option value="1">Primary or less</option>
                                <option value="2">Secondary</option>
                                <option value="3">Tertiary</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="mobile_use_frequency">Mobile Use Frequency (0-4)</label>
                            <select name="mobile_use_frequency" id="mobile_use_frequency">
                                <option value="4">Daily</option>
                                <option value="3">Weekly</option>
                                <option value="2">Monthly</option>
                                <option value="1">Less than once a month</option>
                                <option value="0">Never</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="is_female">Gender</label>
                            <select name="is_female" id="is_female">
                                <option value="1">Female</option>
                                <option value="0">Male</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="is_rural">Residence</label>
                            <select name="is_rural" id="is_rural">
                                <option value="1">Rural</option>
                                <option value="0">Urban</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="is_employed">Employment Status</label>
                            <select name="is_employed" id="is_employed">
                                <option value="1" selected>Employed</option>
                                <option value="0">Unemployed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="has_a_mobile_phone">Has Mobile Phone?</label>
                            <select name="has_a_mobile_phone" id="has_a_mobile_phone">
                                <option value="1" selected>Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="has_smartphone">Has Smartphone?</label>
                            <select name="has_smartphone" id="has_smartphone">
                                <option value="1" selected>Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="used_internet_recently">Used Internet (Last 7 days)?</label>
                            <select name="used_internet_recently" id="used_internet_recently">
                                <option value="1">Yes</option>
                                <option value="0" selected>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="has_national_id">Has National ID?</label>
                            <select name="has_national_id" id="has_national_id">
                                <option value="1" selected>Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="has_saved">Has Savings?</label>
                            <select name="has_saved" id="has_saved">
                                <option value="1">Yes</option>
                                <option value="0" selected>No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="has_borrowed">Has Borrowed?</label>
                            <select name="has_borrowed" id="has_borrowed">
                                <option value="1">Yes</option>
                                <option value="0" selected>No</option>
                            </select>
                        </div>


                    </div>


                    <button type="submit" class="btn-primary">Predict Financial Inclusion</button>
                </form>

                <div id="predictionResult" class="result-area hidden">
                    <div class="result-badge" id="statusBadge"></div>
                    <div class="probability-container">
                        <div class="prob-box">
                            <span class="label">Unbanked Probability</span>
                            <span class="value" id="unbankedProb">0%</span>
                        </div>
                        <div class="prob-box">
                            <span class="label">Banked Probability</span>
                            <span class="value" id="bankedProb">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card batch-section">
                <h2>Batch Processing</h2>
                <p>Upload a CSV file for mass prediction. <a href="/download_sample" class="download-link">Download
                        Sample Template</a></p>
                <form id="batchForm" enctype="multipart/form-data">
                    <div class="file-upload">
                        <input type="file" name="file" id="csvFile" accept=".csv" required>
                        <label for="csvFile">Upload CSV File</label>
                    </div>
                    <button type="submit" class="btn-secondary">Run Batch Prediction</button>
                </form>
                <div id="batchStatus" class="batch-status"></div>

                <div id="batchReport" class="batch-report hidden">
                    <div class="report-summary">
                        <div class="summary-card">
                            <span class="label">Total Records</span>
                            <span class="value" id="totalRecords">0</span>
                        </div>
                        <div class="summary-card">
                            <span class="label">Likely Banked</span>
                            <span class="value banked-color" id="bankedCount">0</span>
                        </div>
                        <div class="summary-card">
                            <span class="label">Likely Unbanked</span>
                            <span class="value unbanked-color" id="unbankedCountReport">0</span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="resultsChart"></canvas>
                    </div>
                    <button id="downloadReportBtn" class="btn-secondary">Download Result CSV</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Store last results for download
        let lastBatchResults = null;
        let resultsChart = null;
        let featureChart = null;

        // Toggle Model Insights Panel
        document.getElementById('toggleInsights').addEventListener('click', function () {
            const panel = document.getElementById('modelInsights');
            const btn = this;

            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                btn.innerText = 'ðŸ“Š Hide Model Insights';

                // Fetch insights if not already loaded or every time?
                // Fetching every time ensures consistency with backend
                fetchModelInsights();

            } else {
                panel.classList.add('hidden');
                btn.innerText = 'ðŸ“Š View Model Insights';
            }
        });

        async function fetchModelInsights() {
            try {
                const res = await fetch('/insights');
                if (!res.ok) throw new Error('Failed to load insights');
                const data = await res.json();

                // Update metrics
                document.getElementById('aucMetric').innerText = data.metrics.roc_auc || 'N/A';
                document.getElementById('recallMetric').innerText = data.metrics.recall || 'N/A';
                document.getElementById('precisionMetric').innerText = data.metrics.precision || 'N/A';

                // Update Feature Importance Chart
                if (data.feature_importance) {
                    updateFeatureChartData(data.feature_importance);
                }

            } catch (err) {
                console.error("Error loading insights:", err);
                // Fallback or leave as Loading...
            }
        }

        function updateFeatureChartData(features) {
            const labels = features.map(f => f.feature);
            const values = features.map(f => Math.abs(f.importance)); // Use magnitude for scale
            const displayLabels = features.map(f => f.label || (Math.abs(f.importance) * 100).toFixed(1) + '%');

            if (featureChart) {
                featureChart.data.labels = labels;
                featureChart.data.datasets[0].data = values;
                featureChart.data.datasets[0].displayLabels = displayLabels;
                featureChart.update();
            } else {
                initializeFeatureChart(labels, values, displayLabels);
            }
        }

        // Initialize Feature Importance Chart
        function initializeFeatureChart(labels, data, displayLabels) {
            const ctx = document.getElementById('featureChart').getContext('2d');

            // Default placeholder data if not provided
            if (!labels) labels = ['Loading...'];
            if (!data) data = [0];
            if (!displayLabels) displayLabels = data.map(v => (v * 100).toFixed(1) + '%');

            featureChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Relative Importance (%)',
                        data: data,
                        displayLabels: displayLabels,
                        backgroundColor: [
                            'rgba(124, 58, 237, 0.7)',
                            'rgba(139, 92, 246, 0.7)',
                            'rgba(167, 139, 250, 0.7)',
                            'rgba(196, 181, 253, 0.7)',
                            'rgba(221, 214, 254, 0.7)'
                        ],
                        borderColor: [
                            'rgba(124, 58, 237, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(167, 139, 250, 1)',
                            'rgba(196, 181, 253, 1)',
                            'rgba(221, 214, 254, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false, // Allow filling container
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.dataset.displayLabels[context.dataIndex];
                                    return context.parsed.x.toFixed(2) + ' (Actual: ' + label + ')';
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#f8fafc',
                            bodyColor: '#f8fafc',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            padding: 12
                        }
                    },
                    layout: {
                        padding: {
                            right: 50 // Space for labels
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 1.0, // Scaled for Relative Importance (100%)
                            ticks: { display: false }, // Hide x-axis labels
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#f8fafc',
                                font: { size: 14, weight: 'bold' } // Increased font size
                            },
                            grid: { display: false }
                        }
                    }
                },
                plugins: [{
                    id: 'customLabels',
                    afterDatasetsDraw(chart, args, options) {
                        const { ctx } = chart;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const percentage = dataset.displayLabels[index];
                                ctx.font = 'bold 12px Outfit';
                                ctx.fillStyle = '#f8fafc';
                                ctx.textAlign = 'left';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(percentage, bar.x + 8, bar.y);
                            });
                        });
                    }
                }]
            });
        }

        // Initialize and update the chart
        function updateChart(bankedCount, unbankedCount) {
            const ctx = document.getElementById('resultsChart').getContext('2d');

            if (resultsChart) {
                // Update existing chart
                resultsChart.data.datasets[0].data = [bankedCount, unbankedCount];
                resultsChart.update();
            } else {
                // Create new chart
                resultsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Likely Banked', 'Likely Unbanked'],
                        datasets: [{
                            data: [bankedCount, unbankedCount],
                            backgroundColor: ['#00ff7f', '#ffc107'],
                            borderColor: ['rgba(0, 255, 127, 0.5)', 'rgba(255, 193, 7, 0.5)'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#f8fafc',
                                    font: { size: 12, family: 'Outfit' },
                                    padding: 15
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#f8fafc',
                                bodyColor: '#f8fafc',
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true
                            }
                        }
                    }
                });
            }
        }

        document.getElementById('predictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const res = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || `Server returned ${res.status}`);
                }

                const resultDiv = document.getElementById('predictionResult');
                const badge = document.getElementById('statusBadge');
                const unbankedEl = document.getElementById('unbankedProb');
                const bankedEl = document.getElementById('bankedProb');

                resultDiv.classList.remove('hidden');
                badge.innerText = data.status;
                badge.className = 'result-badge ' + data.status.toLowerCase();
                unbankedEl.innerText = (data.unbanked_probability * 100).toFixed(2) + '%';
                bankedEl.innerText = (data.banked_probability * 100).toFixed(2) + '%';

                resultDiv.scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                console.error('Prediction error:', err);
                alert('Analysis failed: ' + err.message);
            }
        });

        document.getElementById('batchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusDiv = document.getElementById('batchStatus');
            const reportDiv = document.getElementById('batchReport');

            statusDiv.innerText = 'Uploading CSV file...';
            reportDiv.classList.add('hidden');

            const formData = new FormData(e.target);
            try {
                statusDiv.innerText = 'Processing batch file...';
                const res = await fetch('/batch_predict', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    lastBatchResults = data;

                    statusDiv.innerText = `Successfully processed ${data.length} records.`;

                    // Calculate Statistics
                    const banked = data.filter(r => r.prediction === 1).length;
                    const unbanked = data.length - banked;

                    document.getElementById('totalRecords').innerText = data.length;
                    document.getElementById('bankedCount').innerText = banked;
                    document.getElementById('unbankedCountReport').innerText = unbanked;

                    // Update Chart
                    updateChart(banked, unbanked);

                    reportDiv.classList.remove('hidden');
                } else {
                    const err = await res.json();
                    statusDiv.innerText = 'Error: ' + (err.error || 'Unknown error');
                }
            } catch (err) {
                statusDiv.innerText = 'Submission failed: ' + err.message;
            }
        });

        document.getElementById('downloadReportBtn').addEventListener('click', () => {
            if (!lastBatchResults || lastBatchResults.length === 0) return;

            // Convert JSON to CSV
            const headers = Object.keys(lastBatchResults[0]);
            const csvRows = [];
            csvRows.push(headers.join(','));

            for (const row of lastBatchResults) {
                const values = headers.map(header => {
                    const val = row[header];
                    // Escape commas in values
                    const escaped = ('' + val).replace(/"/g, '""');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'batch_prediction_report.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>

</html>